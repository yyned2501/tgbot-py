#!/bin/bash
set -e  # ä»»ä½•å‘½ä»¤æ‰§è¡Œå¤±è´¥ç«‹å³ç»ˆæ­¢è„šæœ¬

# å¼ºåˆ¶è¦†ç›–å¼æ‹‰å–æœ€æ–°ä»£ç 
git fetch origin "$GIT_BRANCH" || {
    echo "âŒ è·å–è¿œç¨‹åˆ†æ”¯å¤±è´¥"
    exit 1
}

old_commit=$(git rev-parse HEAD)  # è®°å½•å½“å‰æäº¤ID
new_commit=$(git rev-parse origin/"$GIT_BRANCH")  # è·å–è¿œç¨‹æäº¤ID

# æ‰§è¡Œå¼ºåˆ¶è¦†ç›–
git reset --hard "origin/$GIT_BRANCH" || {
    echo "âŒ å¼ºåˆ¶è¦†ç›–æœ¬åœ°åˆ†æ”¯å¤±è´¥"
    exit 1
}

# åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ä¾èµ–
if [ "$old_commit" != "$new_commit" ]; then
    echo "âœ… æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ ($old_commit â†’ $new_commit)"
    
    # å®‰è£…ä¾èµ–
    pip install -r requirements.txt \
        -i http://mirrors.aliyun.com/pypi/simple/ \
        --trusted-host=mirrors.aliyun.com \
        --upgrade || {
        echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
        exit 1
    }
    
    # é‡å¯æœåŠ¡
    supervisorctl restart main || {
        echo "âŒ æœåŠ¡é‡å¯å¤±è´¥"
        exit 1
    }
    echo "ğŸ”„ æœåŠ¡å·²é‡å¯"
else
    echo "âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
fi
